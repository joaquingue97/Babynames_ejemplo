---
title: "Presentación R Baselines"
author: "Joaquin Gueler"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R baseline 

En esta presetación realizaré el ejercico propuesto analizando el dataframe Babynames que contiene, agrupado por nombre y sexo, la cantidad de nacimientos en Estado Unidos por año desde 1880 hasta 2017.


```{r echo = FALSE, include = FALSE}

## Librerias 

# Tidyverse
library(dplyr)
library(purrr)
library(tidyr)
library(ggplot2)

# SQL
library(DBI)
library(odbc)

## Datos 

#install.packages("tidytuesdayR")
# Either ISO-8601 date or year/week works!

tuesdata <- tidytuesdayR::tt_load('2022-03-22')
tuesdata <- tidytuesdayR::tt_load(2022, week = 12)

babynames <- tuesdata$babynames




```

### Pequeño analisis sobre el dataframte 


```{r}
babynames %>% head(10)

```
Control valores Na
```{r}
# control de Na
babynames %>% summarise_all(~ sum(is.na(.)))

```

Analisis columnas

```{r }
 

babynames %>%  summary(.)

```

Analisis de columnas tipo texto 

```{r}
babynames %>%
  select_if(is.character) %>%
  summarise_all(list(
    unique_count = ~ n_distinct(.),
    min_length =   ~ min(nchar(.)),
    max_length =   ~ max(nchar(.)),
    avg_length =   ~ mean(nchar(.), na.rm = TRUE)
  ))  %>%
  gather(Nombres_Columna, Valor, everything()) %>%
  separate(Nombres_Columna, into = c("columna", "Estadística"), sep = "_", extra = "merge") %>%
  spread(columna, Valor)



```
<br>

### Preguntas

Ya habiendo realizado un sucinto analisis sobre las caracteristicas principales del dataframe babynames, me propongo contestar las siguentes preguntas:  

1) Sin distinguir por sexo, cúal es el nombre con mayor peso proporcional al comienzo (1880) y al final (2017) de la serie ? Cómo evolucionaron a lo largo del tiempo?  

2) Cómo evoluionó a lo largo del tiempo la cantidad de nombres únicos utilizados por año?

3) Si agrupamos los nombres en relación a si son utilizados de manera exclusiva por un sexo o no, cúal es el peso proporcional de los nombres mixtos? cómo es su evolución a lo largo del tiempo? 

Para contestar las preguntas voy a crear una tabla temporal en sql server y desde ahí voy producir las agregaciones necesarias. 


```{r results = "hide"}
# Contrucción de tabla temporal 


table_name <- '#Baby_Names'

table_estruc <- '(year int,
                  sex  char(1),
                  name varchar(15),
                  n int,
                  prop float)'


con <- dbConnect(odbc::odbc(), "SQL Server ")

# Crear la tabla temporal en SQL Server
dbExecute(con, paste('create table',table_name,table_estruc),immediate = TRUE) 

# Insertar datos en la tabla temporal desde babynames
dbWriteTable(con, table_name, value = babynames, temporary = TRUE, overwrite = TRUE)




```


```{r  = "hide"}
#Query de prueba 
dbGetQuery(con, paste("select top 10 * from ",table_name,"order by n desc"))

```

### Pregunta 1 
```{r echo = TRUE, results = "hide"}

respuesta_1 <- 
            dbGetQuery(con,
                         
                          " with total_anio as (
                            
                                
                                  select 
                                    ba.year
                                   ,ba.name
                                   ,ba.n
                                   ,ba.n * 1.0 / t1.total as prop 
                                  from (select year,name, sum(n) as n from #Baby_Names group by year,name) as ba
                                  left join (select year,sum(n) as total from #Baby_Names group by year) as t1 
                                  on t1.year = ba.year
                        
                                 ),
                                nombre_mas_popular_extremos_ventana as (
                                
                                    select 
                                      t1.* 
                                    from (select top 1 * from total_anio order by year asc, prop desc) as t1
                                   union 
                                    select 
                                      t2.* 
                                    from (select top 1 * from total_anio order by year desc, prop desc) as t2
                                 )
                                 
                                 select 
                                    t.year
                                   ,t.name
                                   ,t.n
                                   ,t.prop 
                                 from total_anio as t
                                 inner join nombre_mas_popular_extremos_ventana as n
                                 on n.name = t.name; "
                                 
                       )
            

```
<br>
```{r echo=FALSE}

          

nombre_popu_principo <-  respuesta_1  %>%
                         filter(year == min(year))%>% 
                         filter(prop == max(prop))%>% 
                         pull(name) 

nombre_popu_final <-  respuesta_1 %>%
                        filter(year == max(year)) %>% 
                        filter(prop == max(prop)) %>% 
                        pull(name) 


porcentaje_principio <- respuesta_1  %>%
                        filter(name == nombre_popu_principo & year == min(year)) %>% 
                        pull(prop)
                        
  
porcentaje_final <- respuesta_1  %>%
                      filter(name == nombre_popu_final & year == max(year)) %>% 
                      pull(prop) 

respuesta_1 %>% 
  ggplot(aes(x = year, y = prop, group = name, color = name)) +
  geom_line(size = 1) +  
  ggtitle("Evolución del peso porcentual de nombres preponderantes") +
  labs(
      x = "Año",
      y = "Proporción por Nombre",
      subtitle = "Utilizando como ejemplo el nombre más popular de cada extremo de la serie: de 1880 a 2017 ",
      color = "Nombre"
      ) +
  scale_color_brewer(palette = "Set2") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  scale_x_continuous(breaks = seq(min(respuesta_1$year), max(respuesta_1$year), by = 10), expand = c(0, 0))
```

El nombre más popular del primer año de la serie fue `r nombre_popu_principo` con un peso porcentual de `r porcentaje_principio`, a su vez el nombre más 
popular en el último año de la serie fue `r nombre_popu_final` con un peso porcentual de `r porcentaje_final`.
<br>

### Pregunta 2 
```{r echo = TRUE, results = "hide"}

respuesta_2 <- 
              dbGetQuery(con, 
                         " with cantidad_Nombre as (
                                              
                              select 
                                 year
                                ,count(distinct name) as Dist_Name_Nu    
                              from #Baby_Names 
                              group by year
                              
                              )
                           select 
                             year
                            ,Dist_Name_Nu  
                            ,avg(Dist_Name_Nu) over(order by year rows between 5 preceding and 5 following) as Promedio_Decada
                           from cantidad_Nombre; "
              
                        )


            

```
<br>
```{r  echo=FALSE}

primer_anio <- respuesta_2 %>%  
                filter(year == min(year)) %>% 
                pull(year)

ultimo_anio <- respuesta_2 %>%  
                filter(year == max(year)) %>% 
                pull(year)


primer_anio_n <- respuesta_2 %>%  
                      filter(year == min(year)) %>% 
                      pull(Dist_Name_Nu )


ultimo_anio_n <- respuesta_2 %>%  
                  filter(year == max(year)) %>% 
                  pull(Dist_Name_Nu)

diferencia_porcentual <- ((ultimo_anio_n - primer_anio_n )/ primer_anio_n ) * 100

diferencia_porcentual_2 <- paste(round(diferencia_porcentual,2),'%')

          
respuesta_2 %>% 
pivot_longer(cols = c(Dist_Name_Nu, Promedio_Decada),
            names_to = "variable",
            values_to = "value") %>% 
  ggplot(aes(x = year, y = value, color = variable)) +
  geom_line(size = 1) + 
  ggtitle("Evolución de la cantidad de nombres únicos utilizados por año") +
  labs(
    x = "Año",
    y = "Cantidad de nombres", 
    subtitle = "suavizado por el promedio movil de cantidad de nombre únicos por década",
    color = "Variable"
    ) +
  scale_color_brewer(palette = "Set2") + 
  theme_minimal() +
  theme(legend.position = "bottom") +
  scale_x_continuous(breaks = seq(min(respuesta_2$year), max(respuesta_2$year), by = 10), expand = c(0, 0))
```

La cantidad de nombres únicos en el año `r primer_anio` fue de `r primer_anio_n`.En comparación, en el año `r ultimo_anio` fueron `r ultimo_anio_n`,lo que implica un aumento del `r diferencia_porcentual_2`.

<br>


### Pregunta 3
```{r echo = TRUE, results = "hide"}

respuesta_3 <- 
  dbGetQuery(con,   
                  " with t1 as (
                  
                       select
                         year
                         ,name 
                         ,sum(case when sex = 'F' then n else 0 end) as Femenino
                         ,sum(case when sex = 'M' then n else 0 end) as Masculino
                         ,sum(n) as Total 
                       from #Baby_Names
                       group by year,name
                     
                     ),
                     tipo_de_nombres as (
                     
                      select 
                          year
                         ,case when Femenino = Total  then 'Femenino'
                               when Masculino = Total then 'Masculino'
                               else 'Mixto' end as Tipo_nombre
                         ,count(*) as n 
                       from t1
                       group by year,
                                case when Femenino = Total  then 'Femenino'
                                     when Masculino = Total then 'Masculino'
                                else 'Mixto' end
                     
                     ),
                     nombre_unicos as ( 
                     
                         select 
                            year
                           ,count(distinct name) as dist_name_Nu    
                         from #Baby_Names
                         group by year
                     )
                     select
                         tn.year 
                        ,tn.Tipo_nombre
                        ,tn.n * 1.0 / nu.dist_name_Nu as prop
                     from tipo_de_nombres as tn
                     inner join nombre_unicos as nu
                     on nu.year = tn.year; "
                
  )

```
<br>
```{r echo=FALSE}

anio_mayor_prop <- respuesta_3%>%
                    filter(Tipo_nombre == 'Mixto') %>% 
                    filter(prop == max(prop))%>% 
                    pull(year)

mayor_prop <-  respuesta_3  %>%
                filter(Tipo_nombre == 'Mixto') %>% 
                summarise(prop = max(prop)) %>% 
                pull(prop)
                    
                    
promedio_prop <-  respuesta_3  %>%
                    filter(Tipo_nombre == 'Mixto') %>% 
                    summarise(promedio = mean(prop)) %>% 
                    pull(promedio)
                    
prop_ultimo_anio <-  respuesta_3  %>%
                      filter(Tipo_nombre == 'Mixto' & year == max(year))%>% 
                      pull(prop)                   
                    
                    


respuesta_3 %>%           
  ggplot(aes(x = year, y = prop, fill = Tipo_nombre)) +
  geom_area(alpha = 0.7, color = "black") +
  ggtitle("Evolución del peso porcentual de Tipo de Nombre a lo largo del tiempo") +  
  labs(
    x = "Año",
    y = "Proporción", 
    fill = "Tipo de Nombre"
    ) +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  scale_x_continuous(breaks = seq(min(respuesta_3$year), max(respuesta_3$year), by = 10), expand = c(0, 0)) 


```

Los nombres de utilización mixta tienen un peso porcentual promedio a lo largo de la serie de `r promedio_prop`,
con su pico en el año `r anio_mayor_prop` con un peso de `r mayor_prop`.
En el último año tuverion un peso de `r prop_ultimo_anio`.